<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="od-page-nav.html">
<link rel="import" href="touch-test-area.html">
<link rel="import" href="styles/od-global-styles.html">

<dom-module id="od-thoughts-items" attributes="query">
  <template>
    <style include="od-global-styles">
      :host {
        width: 100%;
        @apply(--layout-vertical);
        @apply(--layout-justified);
      }
      .flex {
        @apply(--layout-flex);
      }
      .container {
        height: calc(100vh - 13.5rem);
        position: relative;
        @apply(--layout-vertical);
        @apply(--layout-wrap);

        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .thoughtsItem {
        width: 32rem;
        height: 100%;
        margin-right: 4rem;
        margin-bottom: 2rem;
        overflow: hidden;
        @apply(--layout-vertical);
      }
      .artDate {
        color: grey;
        margin-top: 0;
      }
      .article {
        margin-bottom: 1rem;
        overflow: hidden;
        -webkit-mask-image: -webkit-linear-gradient(rgba(0, 0, 0, 1), rgba(0, 0, 0, 1) 60%, rgba(255, 255, 255, 0));
      }
      @-moz-document url-prefix() {
        .article {
          color: black;
          background: linear-gradient(rgba(0, 0, 0, 1), rgba(0, 0, 0, 1) 60%, rgba(0, 0, 0, 0));
          -webkit-text-fill-color: transparent;
          -webkit-background-clip: text;
        }
      }
      _:-ms-lang(x), _::-webkit-meter-bar, .article {
        color: black;
        background: linear-gradient(rgba(0, 0, 0, 1), rgba(0, 0, 0, 1) 60%, rgba(0, 0, 0, 0));
        -webkit-text-fill-color: transparent;
        -webkit-background-clip: text;
      }
      .artMeta {
        margin-bottom: 1rem;
      }
      #title {
        min-height: 6.75rem;
        margin-bottom: 1rem;
        @apply(--layout-horizontal);
      }
      #title > h2 {
        margin: 0;
        @apply(--layout-self-end);
      }
      /* Mobile Screen Layout Styles */
      .container[mobile-layout] {
        height: calc(100vh - 10.5rem);
      }
      .container[mobile-layout] .thoughtsItem {
        width: 100%;
        margin-right: 1.5rem;
        margin-bottom: 0.5rem;
      }
      .container[mobile-layout] .article {
        margin-bottom: 0;
      }
      .container[mobile-layout] .artFoot {
        display: none;
      }
    </style>

    <iron-media-query
      query="{{query}}"
      query-matches="{{smallScreen}}">
    </iron-media-query>

    <iron-ajax
      auto
      url="{{indexURL}}"
      handle-as="json"
      last-response="{{response}}"
      on-response="handleResponse">
    </iron-ajax>

    <iron-ajax
      auto
      url="{{itemURL}}"
      handle-as="json"
      last-response="{{itemResponse}}"
      on-response="handleItemResponse">
    </iron-ajax>

    <touch-test-area id="touchArea" view-width="{{viewWidth}}" index-length="{{indexLength}}" threshold="{{threshold}}">
      <div id="itemContainer" class="container" mobile-layout$="{{smallScreen}}">
        <template is="dom-repeat" items="{{testArray}}">
          <div class="thoughtsItem">
            <div id="title"><h2>{{item.title}}</h2></div>
            <p class="artDate">{{item.date}}</p>

            <div class="artMeta">
              <template is="dom-repeat" items="{{item.meta}}">
                <a href="#">{{item}}</a>
              </template>
            </div>

            <div class="article flex">
              <template is="dom-repeat" items="{{item.preview}}">
                {{item}}<p></p>
              </template>
            </div>

            <div class="artFoot">
              <a class="button" href="{{item.link}}">Continue Reading</a>
            </div>
          </div>
        </template>
      </div>
    </touch-test-area>

    <od-page-nav id="pageNav"
      on-prev-tap="_prevTap"
      on-next-tap="_nextTap"
      query="{{query}}"
      special-button-text="Continue Reading"
      special-button-link="{{articleLink}}"
      mobile-layout$="{{smallScreen}}">
    </od-page-nav>
  </template>

  <script>
    pressedStates = {
      PREVPRESS: 0,
      NEXTPRESS: 1
    }
    Polymer({

      is: 'od-thoughts-items',

      currentState: pressedStates.NEXTPRESS,

      properties: {
        animationConfig: {
          value: function() {
            return [];
          }
        },

        isCurrentPage: {
          type: Boolean,
        },

        manifestLinks: {
          type: Array,
          value: [],
          notify: true
        },

        initArray: {
          type: Array,
          value: [],
          notify: true
        },

        testArray: {
          type: Array,
          value: [],
          notify: true
        }
      },

      manifestLinks: {
        type: Array,
        value: [],
        notify: true
      },

      manifestIndex: 0,
      viewWidth: 0,
      threshold: 0,
      indexSelector: 0,
      indexLength: 0,
      prevPosition: 0,
      nextPosition: 0,

      listeners: {
        'item-page-changed' : 'navVisibility',
        'site-index-changed' : 'pageStatus'
      },

      ready: function() {
        this.indexURL = '/src/content/item-index.json';

        window.addEventListener('site-index-changed', function(p) {
          return function(e) {
            p.pageStatus(e);
          }
        }(this));

        window.addEventListener('resize', function(p) {
          return function() {
            if (p.isCurrentPage) {
              p.calcGrid(p.$$('#itemContainer'), p.$$('.thoughtsItem'));
            }
          }
        }(this));

        window.addEventListener('WebComponentsReady', function(p) {
          return function() {
            if (p.isCurrentPage) {
              p.calcGrid(p.$$('#itemContainer'), p.$$('.thoughtsItem'));
            }
          }
        }(this));

        window.addEventListener('page-loaded', function(p) {
          return function(e) {
            if (e.detail.targetIndex === 2) {
              p.calcGrid(p.$$('#itemContainer'), p.$$('.thoughtsItem'));
            }
          }
        }(this));
      },

      pageStatus: function(e) {
        if (e.detail.indexTarget === 2) {
          this.isCurrentPage = true;
        } else {
          return
        }
      },

      handleResponse: function() {
        var tempArray = [];

        for (i = 0; i < this.response.thoughts.length; i++) {
          this.manifestLinks.push(this.response.thoughts[i]);

          tempArray.push(i);
        }

        this.testArray = tempArray;

        this.itemURL = this.manifestLinks[this.manifestIndex];
      },

      handleItemResponse: function() {
        this.initArray.push(this.itemResponse);

        ++this.manifestIndex;

        if (this.manifestIndex < this.manifestLinks.length) {
          this.itemURL = this.manifestLinks[this.manifestIndex];
        } else if (this.manifestIndex === this.manifestLinks.length) {
          this.testArray = [];

          this.testArray = this.initArray;
        }

        this.articleLink = this.testArray[this.indexSelector].link;
      },

      calcGrid: function(container, item) {
        var gridW, gridH, pages = null,
            containerW = container.offsetWidth,
            containerH = container.offsetHeight,
            itemMarginRight = parseInt(window.getComputedStyle(item).marginRight);
            itemMarginBottom = parseInt(window.getComputedStyle(item).marginBottom);
            itemW = item.offsetWidth + itemMarginRight,
            itemH = item.offsetHeight + itemMarginBottom;

        gridW = Math.floor(containerW / itemW);
        gridH = Math.floor(containerH / itemH);

        if (gridW === 0) {
          gridW = 1;
        }

        rawPageNum = this.testArray.length / (gridW * gridH);

        if (rawPageNum === 1) {
          calcPages = 0
        } else if (rawPageNum > 1) {
          calcPages = Math.ceil(rawPageNum);
        } else {
          calcPages = Math.floor(rawPageNum);
        }

        pages = calcPages;

        if (this.smallScreen) {
          this.threshold = 200;
        } else {
          this.threshold = 400;
        }

        this.viewWidth = itemW * gridW;
        this.indexLength = pages;

        if (this.indexLength === 0) {
          this.$.pageNav.style.visibility = 'hidden';
        } else {
          this.$.pageNav.style.visibility = 'visible';
        }

        this.fire('made-grid', {width: this.viewWidth, length: this.indexLength, content: container});
      },

      translateView: function(direction) {
        var engine = this.$.touchArea;

        switch (direction) {
          case 'next':
            engine.execAnim(engine.content, direction, false);
            break;
          case 'prev':
            engine.execAnim(engine.content, direction, false);
            break;
          default:
            console.log('udunfuckdup');
        }
      },

      navVisibility: function(e) {
        indexInit = this.indexSelector;
        this.indexSelector = e.detail.indexSelector;

        if (this.indexSelector === 0 && indexInit > 0) {
          this.$.pageNav.hidePrevButton();
        }

        if (this.indexSelector === 1 && e.detail.vector === 'next') {
          this.$.pageNav.showPrevButton();
        }

        if (this.indexSelector === (this.indexLength - 2) && e.detail.vector === 'prev') {
          this.$.pageNav.showNextButton();
        }

        if (this.indexSelector === (this.indexLength - 1) && indexInit === (this.indexLength - 2)) {
          this.$.pageNav.hideNextButton();
        }

        this.articleLink = this.testArray[this.indexSelector].link;
      },

      _prevTap: function() {
        this.currentState = pressedStates.PREVPRESS;

        if (this.indexSelector > 0) {
          this.translateView('prev');
        }

        this.fire('item-page-changed', {vector: 'prev', indexSelector: this.indexSelector});
      },

      _nextTap: function() {
        this.currentState = pressedStates.NEXTPRESS;

        if (this.indexSelector < this.indexLength) {
          this.translateView('next');
        }

        this.fire('item-page-changed', {vector: 'next', indexSelector: this.indexSelector});
      }
    });
  </script>
</dom-module>
