<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="od-page-nav.html">
<link rel="import" href="touch-test-area.html">

<dom-module id="od-thoughts-items" attributes="query">
  <template>

    <style>
      :host {
        @apply(--layout-vertical);
        @apply(--layout-justified);
      }
      .container {
        height: calc(100vh - 13.5rem);
        position: relative;
        @apply(--layout-vertical);
        @apply(--layout-wrap);

        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .button {
        display: inline-block;
        padding: 1rem;
        border: 1px solid lightgrey;
        border-radius: 5px;
        cursor: pointer;
      }
      .button:hover {
        color: white;
        background: lightgrey;
      }
      .thoughtsItem {
        width: 32rem;
        margin-right: 4rem;
        margin-bottom: 2rem;
        overflow: hidden;
        @apply(--layout-vertical);
      }
      .thoughtsItem > h2 {
        margin-top: 1.2rem;
        margin-bottom: 0;
      }
      .artDate {
        color: grey;
      }
      .article {
        margin-bottom: 1rem;
        overflow: hidden;
        -webkit-mask-image: -webkit-linear-gradient(rgba(0, 0, 0, 1), rgba(0, 0, 0, 1) 60%, rgba(255, 255, 255, 0));
      }
      @-moz-document url-prefix() {
        .article {
          color: black;
          background: linear-gradient(rgba(0, 0, 0, 1), rgba(0, 0, 0, 1) 60%, rgba(0, 0, 0, 0));
          -webkit-text-fill-color: transparent;
          -webkit-background-clip: text;
        }
      }
      _:-ms-lang(x), _::-webkit-meter-bar, .article {
        color: black;
        background: linear-gradient(rgba(0, 0, 0, 1), rgba(0, 0, 0, 1) 60%, rgba(0, 0, 0, 0));
        -webkit-text-fill-color: transparent;
        -webkit-background-clip: text;
      }
      /* Mobile Screen Layout Styles */
      .container[mobile-layout] {
        height: calc(100vh - 10.5rem);
      }
      .container[mobile-layout] .thoughtsItem {
        width: 100%;
        margin-right: 1.5rem;
        margin-bottom: 0.5rem;
      }
      .container[mobile-layout] .article {
        margin-bottom: 0;
      }
      .container[mobile-layout] .artFoot{
        display: none;
      }
    </style>

    <iron-media-query
      query="{{query}}"
      query-matches="{{smallScreen}}">
    </iron-media-query>

    <touch-test-area id="touchArea" view-width="{{viewWidth}}" index-length="{{indexLength}}" threshold="{{threshold}}">
      <div id="itemContainer" class="container" mobile-layout$="{{smallScreen}}">
        <template is="dom-repeat" items="{{testArray}}">
          <div class="thoughtsItem">
            <h2>Test Article Title</h2>
            <p class="artDate">August 21st, 2016</p>
            <div class="artMeta">
              <a href="#">#HashTag</a>,
              <a href="#">#HashTag</a>,
              <a href="#">#HashTag</a>,
              <a href="#">#HashTag</a>
            </div>
            <div class="article">

                When we humans navigate the world around us, we do so through the
                analysation of all the data that is absorbed by our senses and
                combine it with our inherent knowledge. There are the usual senses
                people can identify which are the most obvious like sight, sound, touch,
                taste and smell but there are an abundance of others that are implicit
                in the everyday, things like thermoception (the ability to detect
                temperature) and proprioception (the ability to sense where your body
                is in space).<p></p>As soon as we enter the digital world, we lose almost all of our senses;
                we are primarily relying on learned knowledge accumulated through past
                experiences. Vision is our primary sense stimulated through the use
                of visual displays, sometimes sound is present trhough speakers and
                even rarer still is the use of touch through vibration. These seem
                to be the only three senses stimulated in mainstream digital devices.
                Out of the three, vision is the only sense that permeates all digital
                experiences that humans encounter on a daily basis; one sense out of
                many. Not only do interfaces have to have to account for this lack
                of sensorial input but they have to communicate a visual language
                that accounts for this. This puts enormous strain on a user's past
                knowledge to navigate an interface; since the base knowledge of the
                everyday user varies wildly so does the effective mileage of any given
                interface.<p></p>There's a reason why Apple used skeuomorphism when they first released
                the iPhone. The visual replication of real, tangible objects in an
                interface to communicate how one might interact with them in a digital
                way makes sense; certain physical objects provide affordances that
                contextual-less digital artefacts can't. Prior to the iPhone, there
                had been no uniform visual language to relay how one might interact
                with an interface totally reliant on touch. The Notepad app looked
                like an actual note pad, with yellow paper pages and stitching, buttons
                had visual cues to make them look three dimensional that depressed
                when touched much like one would expect to see in the real world.
                iOS was brand new at the time so they had to communicate how to navigate
                the world that they had created in terms that they knew the everyday
                user would understand.<p></p>

            </div>
            <div class="artFoot">
              <div class="button">Continue Reading</div>
            </div>
          </div>
        </template>
      </div>
    </touch-test-area>

    <od-page-nav id="pageNav"
      on-prev-tap="_prevTap"
      on-next-tap="_nextTap"
      query="{{query}}"
      special-button-text="Continue Reading"
      mobile-layout$="{{smallScreen}}">
    </od-page-nav>
  </template>

  <script>
    pressedStates = {
      PREVPRESS: 0,
      NEXTPRESS: 1
    }
    Polymer({

      is: 'od-thoughts-items',

      currentState: pressedStates.NEXTPRESS,

      properties: {
        animationConfig: {
          value: function() {
            return [];
          }
        }
      },

      viewWidth: 0,
      threshold: 0,
      indexSelector: 0,
      indexLength: 0,
      prevPosition: 0,
      nextPosition: 0,

      listeners: {
        'item-page-changed' : 'navVisibility'
      },

      ready: function() {
        this.testArray = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19];

        window.addEventListener('resize', function(p) {
          return function() {
            p.calcGrid(p.$$('#itemContainer'), p.$$('.thoughtsItem'));
          }
        }(this));
        window.addEventListener('page-loaded', function(p) {
          return function(e) {
            if (e.detail.targetIndex === 2) {
              p.calcGrid(p.$$('#itemContainer'), p.$$('.thoughtsItem'));
            }
          }
        }(this));
      },

      calcGrid: function(container, item) {
        var gridW, gridH, pages = null,
            containerW = container.offsetWidth,
            containerH = container.offsetHeight,
            itemMarginRight = parseInt(window.getComputedStyle(item).marginRight);
            itemMarginBottom = parseInt(window.getComputedStyle(item).marginBottom);
            itemW = item.offsetWidth + itemMarginRight,
            itemH = item.offsetHeight + itemMarginBottom;

        gridW = Math.round(containerW / itemW);
        gridH = Math.floor(containerH / itemH);

        pages = Math.ceil(this.testArray.length / (gridW * gridH));

        if (this.smallScreen) {
          this.threshold = 200;
        } else {
          this.threshold = 400;
        }

        this.viewWidth = itemW * gridW;
        this.indexLength = pages;

        this.fire('made-grid', {width: this.viewWidth, length: this.indexLength, content: container});
      },

      translateView: function(direction) {
        var engine = this.$.touchArea;

        switch (direction) {
          case 'next':
            engine.execAnim(engine.content, direction, false);
            break;
          case 'prev':
            engine.execAnim(engine.content, direction, false);
            break;
          default:
            console.log('udunfuckdup');
        }
      },

      navVisibility: function(e) {
        indexInit = this.indexSelector;
        this.indexSelector = e.detail.indexSelector;

        if (this.indexSelector === 0 && indexInit > 0) {
          this.$.pageNav.hidePrevButton();
        }

        if (this.indexSelector === 1 && e.detail.vector === 'next') {
          this.$.pageNav.showPrevButton();
        }

        if (this.indexSelector === (this.indexLength - 2) && e.detail.vector === 'prev') {
          this.$.pageNav.showNextButton();
        }

        if (this.indexSelector === (this.indexLength - 1) && indexInit === (this.indexLength - 2)) {
          this.$.pageNav.hideNextButton();
        }
      },

      _prevTap: function() {
        this.currentState = pressedStates.PREVPRESS;

        if (this.indexSelector > 0) {
          this.translateView('prev');
        }

        this.fire('item-page-changed', {vector: 'prev', indexSelector: this.indexSelector});
      },

      _nextTap: function() {
        this.currentState = pressedStates.NEXTPRESS;

        if (this.indexSelector < this.indexLength) {
          this.translateView('next');
        }

        this.fire('item-page-changed', {vector: 'next', indexSelector: this.indexSelector});
      }
    });
  </script>
</dom-module>
