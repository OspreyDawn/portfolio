<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-iconset/iron-iconset.html">

<link rel="import" href="od-iconset.html">
<link rel="import" href="styles/od-global-styles.html">

<dom-module id="od-ambient-icons" attributes="small-screen">
  <template>
    <style include="od-global-styles">
      iron-icon {
        display: block;
        position: absolute;
        z-index: 0;
        width: 50px;
        height: 50px;
        top: calc(50% - 25px);
        left: calc(50% - 25px);
        opacity: 0;
        fill: var(--indigo);
      }
    </style>
    <content></content>

    <iron-meta type="iconset" id="meta"><iron-meta>
  </template>

  <script>
    var iterations = 0;

    function shuffle(array) {
      var currentIndex = array.length, temporaryValue, randomIndex;

      // While there remain elements to shuffle...
      while (0 !== currentIndex) {

        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;

        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }

      return array;
    }

    calcAnim = function(element, canvasX, canvasY, delay, mobile) {
      var xEnd, yEnd,
          animKey = [],
          animTime,
          mainAxis = Math.random() < 0.5 ? 'x' : 'y',
          durationLength = 0,
          timingDuration = Math.random() * durationLength,
          timingDelay = 0;

      var pathDirection = function() {
        if (Math.random() < 0.5) {
          return 1;
        } else {
          return -1;
        }
      }

      if (mobile) {
        durationLength = 72000;
      } else {
        durationLength = 144000;
      }

      if (delay) {
        timingDelay = 2000 * (iterations * Math.random());

        ++iterations;
      }

      if (timingDuration < (durationLength / 2)) {
        timingDuration = timingDuration + (durationLength / 2);
      }

      if (mainAxis === 'x') {
        xEnd = (canvasX / 2) * pathDirection();
        yEnd = (canvasY / 2) * Math.random() * pathDirection();
      } else {
        xEnd = (canvasX / 2) * Math.random() * pathDirection();
        yEnd = (canvasY / 2) * pathDirection();
      }

      if (yEnd > 0 && xEnd > 0) {
        yEnd * -1;
      }

      animKey = [{
          transform: 'translateX(0) translateY(0) rotate(0deg)',
          opacity: 0.77
        }, {
          transform: 'translateX(' + xEnd + 'px) translateY(' + yEnd + 'px) rotate(360deg)',
          opacity: 0
        }];

      animTime = {
          duration: timingDuration,
          delay: timingDelay
        };

      var definedAnim = element.animate(animKey, animTime);

      definedAnim.onfinish = function() {
        calcAnim(element, canvasX, canvasY, false, mobile);
      }
    }

    Polymer({

      is: 'od-ambient-icons',

      properties: {
        iconNameList: {
          type: Array,
          value: []
        },
        canvasWidth: {
          value: 0
        },
        canvasHeight: {
          value: 0
        },
        iconsToAnimate: {
          type: Array,
          value: []
        }
      },

      ready: function() {
        this.iconNameList = this.$.meta.byKey('ambient-icons').getIconNames();

        shuffle(this.iconNameList);

        for(i = 0; i < this.iconNameList.length; i++) {
          this.createIcon(this.iconNameList[i]);
        }

        window.addEventListener('WebComponentsReady', function(p) {
          return function () {
            p.canvasWidth = p.$$('iron-icon').parentElement.offsetWidth;
            p.canvasHeight = p.$$('iron-icon').parentElement.offsetHeight;

            for(i = 0; i < p.iconsToAnimate.length; i++) {
              calcAnim(p.iconsToAnimate[i], p.canvasWidth, p.canvasHeight, true, p.smallScreen);
            }
          }
        }(this));

        window.addEventListener('resize', function(p) {
          return function () {
            p.canvasWidth = p.$$('iron-icon').parentElement.offsetWidth;
            p.canvasHeight = p.$$('iron-icon').parentElement.offsetHeight;
          }
        }(this));
      },

      createIcon: function(iconName) {
        var newElement = document.createElement('iron-icon');

        newElement.setAttribute('icon', iconName);

        Polymer.dom(this.root).appendChild(newElement);

        this.iconsToAnimate.push(newElement);

        return newElement;
      },
    });
  </script>
</dom-module>
