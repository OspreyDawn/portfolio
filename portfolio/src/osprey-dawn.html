<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">

<link rel="import" href="od-portrait.html">
<link rel="import" href="hero-pager.html">
<link rel="import" href="grey-box-work.html">
<link rel="import" href="grey-box-thoughts.html">
<link rel="import" href="od-page-maker.html">

<dom-module id="osprey-dawn">
  <template>

    <style>
      :host {
        @apply(--layout-fullbleed);
        overflow: hidden;
      }
      #orientOverlay {
        display: none;
      }
      #loadOverlay {
        width: 100%;
        height: 100%;
        position: absolute;
        z-index: 1;
        background-color: white;
      }
      @media (max-width: 750px) and (orientation:landscape) {
        neon-animated-pages {
          position: relative;
          z-index: 0;
        }
        #orientOverlay {
          display: block;
          background: white;
          position: absolute;
          z-index: 1;
          width: 100%;
          height: 100%;
          @apply(--layout-horizontal);
          @apply(--layout-center-center);
        }
      }
    </style>

    <od-portrait id="portrait" query="{{mediaQuery}}"></od-portrait>

    <neon-animated-pages
      id="pages"
      attr-for-selected="id"
      selected="{{selected}}"
      on-neon-animation-finish="indexChanged">

      <hero-pager id="hero" query="{{mediaQuery}}"></hero-pager>
      <grey-box-work id="work" query="{{mediaQuery}}"></grey-box-work>
      <grey-box-thoughts id="thoughts" query="{{mediaQuery}}"></grey-box-thoughts>

    </neon-animated-pages>
    <div id="orientOverlay"><p>Please rotate to Portrait to view this website</p></div>
    <div id="loadOverlay"></div>

  </template>

  <script>
    Polymer({

      is: 'osprey-dawn',

      properties: {
        prop1: {
          type: String,
          value: 'osprey-dawn',
        },
        mediaQuery: {
          type: String,
          value: 'max-width: 450px'
        },
        selected: {
          type: String
        },
        siteIndex: {
          type: Array,
          value: []
        },
        indexSelector: {
          value: 0
        },
        indexLength: {
          value: 0
        },
        itemPages: {
          type: Array,
          value: []
        }
      },

      listeners: {
        'wheel' : 'wheelFire',
        'wheel-state' : 'wheelState',
        'create-page' : 'createPage',
        'delete-page' : 'deletePage',
        'to-hero' : 'backPressed',
        'change-site-index' : 'indexDestiny',
      },

      ready: function() {
        for (var i = 0; i < this.$.pages.children.length; ++i) {
          this.siteIndex.push(this.$.pages.children[i].id);
        };

        this.indexLength = this.siteIndex.length;
        this.selected = this.siteIndex[this.indexSelector];

        window.addEventListener('WebComponentsReady', function(p) {
          return function() {
            p.$.loadOverlay.style.display = 'none';
          }
        }(this));
      },

      indexDestiny: function(e) {
        if (this.indexSelector === 0) {
          this.$.portrait.downSlide();
        }

        if (e.detail.targetIndex === 0) {
          this.$.portrait.upSlide();
        }

        this.indexSelector = e.detail.targetIndex;
        this.selected = this.siteIndex[this.indexSelector];
      },

      translateWheel: function(e) {
        if (e.deltaMode == 0) {
          return e
        }

        var newDelta = e.deltaY * 16;
        var newWheel = new WheelEvent('newWheel', {'deltaY': newDelta,'deltaMode': 0});

        return newWheel;
      },

      wheelFire: function(e) {
        var ePrime = this.translateWheel(e)
        var wDelta = ePrime.deltaY;
        var index = this.indexSelector;

        if (16 < wDelta && this.indexSelector < (this.indexLength - 1)) {
          ++index
        } else if (wDelta < -16 && this.indexSelector > 0) {
          --index;
        } else {
          return
        };

        if (16 < wDelta || wDelta < -16) {
          this.fire('change-site-index', {targetIndex: index});
          this.unlisten(this, 'wheel', 'wheelFire');
        } else {
          return
        }
      },

      indexChanged: function() {
        this.listen(this, 'wheel', 'wheelFire');
        this.fire('page-changed', {targetIndex: this.indexSelector});
      },

      createPage: function() {
        newPage = document.createElement('od-page-maker');
        newPage.style.zIndex = 2;
        newPage.setAttribute('id', 'itemPage');
        this.appendChild(newPage);
        this.itemPages.push(newPage);
        this.fire('call-page', {pageCall: 'enter'});
        this.fire('wheel-state', {active: false});
      },

      deletePage: function() {
        length = this.itemPages.length - 1;
        page = this.itemPages[length];
        this.removeChild(page);
        this.fire('wheel-state', {active: true});
      },

      wheelState: function(e) {
        if (e.detail.active) {
          this.listen(this, 'wheel', 'wheelFire');
        } else {
          this.unlisten(this, 'wheel', 'wheelFire');
        }
      }
    });
  </script>
</dom-module>
