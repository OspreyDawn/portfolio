<link rel="import" href="../bower_components/app-elements/app-elements.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">

<link rel="import" href="od-portrait.html">
<link rel="import" href="hero-pager.html">
<link rel="import" href="grey-box-work.html">
<link rel="import" href="grey-box-thoughts.html">
<link rel="import" href="item-page-manager.html">

<link rel="import" href="styles/od-global-styles.html">

<dom-module id="osprey-dawn">
  <template>
    <style include="od-global-styles"><style>
      item-page-manager {
        z-index: 2;
      }
      :host {
        width: 100vw;
        height: 100vh;
        display: block;
      }
      #pages {
        display: block;
        width: 100%;
        height: 100%;
      }
      #orientOverlay {
        display: none;
      }
      #loadOverlay {
        width: 100%;
        height: 100%;
        position: absolute;
        z-index: 1;
        background-color: white;
      }
      @media (max-width: 450px) and (orientation:landscape) {
        neon-animated-pages {
          position: relative;
          z-index: 0;
        }
        #orientOverlay {
          display: block;
          background: white;
          position: absolute;
          z-index: 1;
          width: 100%;
          height: 100%;
          @apply(--layout-horizontal);
          @apply(--layout-center-center);
        }
      }
    </style>

    <app-location
        route="{{route}}"
        use-hash-as-path>
    </app-location>

    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{pageData}}">
    </app-route>

    <od-portrait
      id="portrait"
      query="{{mediaQuery}}">
    </od-portrait>

    <neon-animated-pages
      id="pages"
      attr-for-selected="id"
      selected="{{selected}}"
      on-neon-animation-finish="neonPageLoaded">

      <hero-pager id="home" query="{{mediaQuery}}"></hero-pager>
      <grey-box-work id="work" query="{{mediaQuery}}"></grey-box-work>
      <grey-box-thoughts id="thoughts" query="{{mediaQuery}}"></grey-box-thoughts>
    </neon-animated-pages>

    <item-page-manager query="{{mediaQuery}}"></item-page-manager>

    <div id="orientOverlay"><p>Please rotate to Portrait to view this website</p></div>
    <div id="loadOverlay"></div>

  </template>

  <script>
    Polymer({

      is: 'osprey-dawn',

      behaviors: [
        Polymer.NeonAnimatableBehavior,
        Polymer.NeonAnimationRunnerBehavior
      ],

      properties: {
        animationConfig: {
          value: function() {
            return [];
          }
        },
        isMobileSafari: {
          type: Boolean,
          value: false
        },
        pagesReady: {
          type: Boolean,
          value: false
        },
        route: {
          type: Object,
          observer: 'handleRoute'
        },
        mediaQuery: {
          type: String,
          value: 'max-width: 450px'
        },
        heroState: {
          type: Boolean,
          value: true
        },
        selected: {
          type: String
        },
        siteIndex: {
          type: Array,
          value: []
        },
        indexSelector: {
          value: 0,
          observer: 'indexChanged'
        },
        indexPrevious: {
          value: 0
        },
        indexLength: {
          value: 0
        },
        loadingContainer: {
          type: Object
        },
      },

      listeners: {
        'wheel' : 'wheelFire',
        'wheel-state' : 'wheelState'
      },

      ready: function() {
        this.iPhoneSafariCheck();

        for (var i = 0; i < this.$.pages.children.length; ++i) {
          this.siteIndex.push(this.$.pages.children[i].id);
        };

        this.indexLength = this.siteIndex.length;
        this.selected = this.siteIndex[this.indexSelector];

        window.addEventListener('WebComponentsReady', function(p) {
          return function() {
            if (!p.loadingContainer) {
              p.loadingContainer = p.$.home.getElements('home');
            }

            p.$.loadOverlay.style.display = 'none';
            p.loadAnimation(p.loadingContainer);
          }
        }(this));
      },

      iPhoneSafariCheck: function() {
        var ua = window.navigator.userAgent,
            iPhone = !!ua.match(/iPhone/i),
            webkit = !!ua.match(/Webkit/i),
            mobileSafari = iPhone && webkit && !ua.match(/CriOS/i) && !ua.match(/OPiOS/i);

        if (mobileSafari) {
          this.isMobileSafari = true;
          this.style.height =  'calc(100vh - 68px)';

          this.fire('is-mobile-safari');
          this.handleiOSTouch(true);
        }
      },

      handleiOSTouch: function(bool) {
        if (bool) {
          document.body.addEventListener('touchmove', this.eventPrevention, false);
        } else {
          document.body.removeEventListener('touchmove', this.eventPrevention, false);
        }
      },

      eventPrevention: function(e) {
        e.preventDefault();
      },

      indexChanged: function() {
        this.fire('site-index-changed', {
          indexTarget: this.indexSelector,
          prevTarget: this.indexPrevious,
          pagesReady: this.pagesReady
        });
      },

      translateWheel: function(e) {
        if (e.deltaMode === 0) {
          return e
        }

        var newDelta = e.deltaY * 16;
        var newWheel = new WheelEvent('newWheel', {'deltaY': newDelta,'deltaMode': 0});

        return newWheel;
      },

      wheelFire: function(e) {
        var ePrime = this.translateWheel(e)
        var wDelta = ePrime.deltaY;

        this.indexPrevious = this.indexSelector;

        if (16 < wDelta && this.indexSelector < (this.indexLength - 1)) {
          ++this.indexSelector;
        } else if (wDelta < -16 && this.indexSelector > 0) {
          --this.indexSelector;
        } else {
          return
        };

        if (16 < wDelta || wDelta < -16) {
          window.location = '#/' + this.siteIndex[this.indexSelector];
          this.unlisten(this, 'wheel', 'wheelFire');
        } else {
          return
        }
      },

      wheelState: function(e) {
        if (!e.detail.active) {
          this.unlisten(this, 'wheel', 'wheelFire');

          if (this.isMobileSafari) {
            this.handleiOSTouch(false);
          }
        } else {
          this.listen(this, 'wheel', 'wheelFire');

          if (this.isMobileSafari) {
            this.handleiOSTouch(true);
          }
        }
      },

      neonPageLoaded: function() {
        this.listen(this, 'wheel', 'wheelFire');
        this.fire('page-loaded', {targetIndex: this.indexSelector});
      },

      handleRoute: function() {
        this.indexPrevious = this.indexSelector;
        homePage = this.$.home;

        if (this.pageData) {

          if (!this.pagesReady) {
            this.pagesReady = true;
          }

          switch (this.pageData.page) {
            case 'about':
              this.heroState = false;
              this.unlisten(this, 'wheel', 'wheelFire');

              this.fire('hero-index-changed', {indexTarget: 1});
              this.indexSelector = 0;
              this.loadingContainer = homePage.getElements(this.pageData.page);

              if (this.isMobileSafari) {
                this.handleiOSTouch(false);
              }
              break;
            case 'home':
              this.indexSelector = 0;
              this.loadingContainer = homePage.getElements('home');
              break;
            case 'work':
              this.indexSelector = 1;
              break;
            case 'thoughts':
              this.indexSelector = 2;
              break;
            default:
              console.log('wtfm8');
              return
            }

          if (!this.heroState && this.pageData.page != 'about') {
            this.heroState = true;
            this.listen(this, 'wheel', 'wheelFire');

            this.fire('hero-index-changed', {indexTarget: 0});

            if (this.isMobileSafari) {
              this.handleiOSTouch(true);
            }
          }
          this.selected = this.siteIndex[this.indexSelector];
        }
      },

      loadAnimation: function(container) {
        var neonElements = container.children;

        var neonArray = Array.prototype.slice.call(neonElements);

        this.animationConfig['load-in'] = [{
          name: 'cascaded-animation',
          animation: 'fade-in-animation',
          nodes: neonArray,
          timing: {
            delay: 2500,
            duration: 1000
          }
        }, {
          name: 'cascaded-animation',
          animation: 'slide-from-top-animation',
          nodes: neonArray,
          timing: {
            delay: 2500,
            duration: 1000
          }
        }];
        this.playAnimation('load-in');
      },
    });
  </script>
</dom-module>
