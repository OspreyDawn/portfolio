<link rel="import" href="../bower_components/app-elements/app-elements.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">

<link rel="import" href="item-page.html" attribute="query">

<dom-module id="item-page-manager">
  <template>
    <style>
      :host {
        display: none;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0
      }
      #overlay {
        width: 100%;
        height: 100%;
        position: absolute;
        background: rgba(0, 0, 0, 0.28);
        opacity: 0;
      }
    </style>

    <app-location
        route="{{route}}"
        use-hash-as-path>
    </app-location>

    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{pageData}}"
      tail="{{subRoute}}">
    </app-route>

    <app-route
      route="{{subRoute}}"
      pattern="/:item"
      data="{{subRouteData}}">
    </app-route>

    <div id="overlay"></div>

  </template>

  <script>
    pageState = {
      OUTVIEW: 0,
      INVIEW: 1
    };

    Polymer({

      is: 'item-page-manager',

      currentState: pageState.OUTVIEW,

      behaviors: [Polymer.NeonAnimationRunnerBehavior],

      properties: {
        subRoute: {
          type: Object,
          observer: 'handleRoute'
        },

        animationConfig: {
            value: function() {
              return {
                'overlay-fade-in': {
                  name: 'fade-in-animation',
                  node: this.$.overlay
                },
                'overlay-fade-out': {
                  name: 'fade-out-animation',
                  node: this.$.overlay,
                  timing: {
                    delay: 250
                  }
                }
              }
          }
        },

        deleteAction: {
          type: Boolean,
          value: false
        },

        previousPage: {
          type: Object
        },

        currentPage: {
          type: Object
        },

        currentOverlay: {
          value: null
        },

        pageArray: {
          type: Array,
          value: []
        },
      },

      listeners: {
        'neon-animation-finish' : '_onNeonAnimationFinish'
      },

      ready: function() {
        window.addEventListener('WebComponentsReady', function(p) {
          return function() {
            if (p.pageArray.length === 1) {
              p.fire('wheel-state', {active: false});
            }
          }
        }(this));
      },

      openPage: function(item) {
        if (this.pageArray.length === 0) {
          this.fire('wheel-state', {active: false});
        }

        this.createPage(item);
        this.initOverlay();

        this.playAnimation('overlay-fade-in');
        this.pageEnterAnim(this.currentPage);
      },

      initOverlay: function() {
        this.currentState = pageState.INVIEW;
        this.$.overlay.style.zIndex = 3 + this.pageArray.length;
      },

      createPage: function(item) {
        var newPage = document.createElement('item-page');
        var host = this.pageData.page;
        var pageIndex = this.pageArray.length - 1;

        this.appendChild(newPage);

        newPage.setAttribute('query', this.query);
        newPage.setAttribute('id', item);
        newPage.setAttribute('host', host);
        newPage.setAttribute('item', item);
        newPage.style.display = 'none';
        newPage.style.zIndex = 4 + this.pageArray.length;

        this.fire('item-page-created');

        if (!this.currentPage) {
          newPage.setAttribute('exit', '#/' + newPage.host);
        } else {
          this.previousPage = this.currentPage;

          newPage.setAttribute('exit', '#/' + this.pageArray[pageIndex].host + '/' + this.pageArray[pageIndex].item);
        }

        this.pageArray.push(newPage);

        this.currentPage = newPage;
      },

      closePage: function() {
        if (this.currentPage) {
          this.currentState = pageState.OUTVIEW;
          this.pageExitAnim(this.currentPage);
          this.deletePage();
          this.playAnimation('overlay-fade-out');
        } else {
          return
        }
      },

      deletePage: function() {
        this.pageArray.splice(-1, 1);

        if (this.pageArray.length > 1) {
          this.previousPage = this.pageArray[this.pageArray.length - 2];
        } else {
          delete this.previousPage;
        }

        setTimeout(function(p) {
          return function() {
            p.removeChild(p.currentPage);

            p.currentPage = p.pageArray[p.pageArray.length - 1];
          }
        }(this), 250);
      },

      pageEnterAnim: function(element) {
        element.style.display = 'block';

        this.animationConfig['page-enter'] = {
          name: 'slide-from-right-animation',
          node: element,
          timing: {
            delay: 250
          }
        };

        this.playAnimation('page-enter');
      },

      pageExitAnim: function(element) {
        this.animationConfig['page-exit'] = {
          name: 'slide-right-animation',
          node: element
        };

        this.playAnimation('page-exit');
      },

      handleRoute: function() {
        if (this.subRouteData && this.subRouteData.item) {
          this.style.display = 'block';

          if (this.currentPage && this.previousPage) {
            switch (this.subRouteData.item) {
              case this.currentPage.item:
                return
                break;
              case this.previousPage.item:
                this.closePage();
                break;
              default:
                this.openPage(this.subRouteData.item);
            }
          } else {
            this.openPage(this.subRouteData.item);
          }

          delete this.subRouteData.item;
        } else if (this.subRouteData && !this.subRouteData.item) {
          var currentLength = (this.pageArray.length - 1);

          for (i = 0; i < (currentLength); i++) {
            this.removeChild(this.pageArray[0]);
            this.pageArray.splice(0, 1);
          }

          this.closePage();
        }
      },

      _onNeonAnimationFinish: function() {
        switch (this.currentState) {
          case pageState.OUTVIEW:
            if (this.pageArray.length > 0) {
              window.location = '#/' + this.currentPage.getAttribute('host') + '/' + this.currentPage.getAttribute('item');

              this.$.overlay.style.zIndex = this.$.overlay.style.zIndex = 3 + this.pageArray.length;
            } else {
              window.location = '#/' + this.pageData.page + '/';

              this.$.overlay.style.opacity = 0;
              this.style.display = 'none';
              this.fire('wheel-state', {active: true});
            }
            break;
          case pageState.INVIEW:
            this.$.overlay.style.opacity = 1;
            break;
          default:
            console.log('wellshit');
        }
      }
    });
  </script>
</dom-module>
