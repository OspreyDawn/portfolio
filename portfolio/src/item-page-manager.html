<link rel="import" href="../bower_components/app-elements/app-elements.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">

<link rel="import" href="item-page.html">

<dom-module id="item-page-manager">
  <template>
    <style>
      :host {
        display: none;
        width: 100%;
        height: 100%;
        position: absolute;
      }
      #overlay {
        width: 100%;
        height: 100%;
        position: absolute;
        background: rgba(0, 0, 0, 0.28);
        opacity: 0;
      }
    </style>

    <app-location
        route="{{route}}"
        use-hash-as-path>
    </app-location>

    <app-route
      route="{{route}}"
      pattern="/:page"
      data="{{pageData}}"
      tail="{{subRoute}}">
    </app-route>

    <app-route
      route="{{subRoute}}"
      pattern="/:item"
      data="{{subRouteData}}">
    </app-route>

    <div id="overlay"></div>

  </template>

  <script>
    pageState = {
      OUTVIEW: 0,
      INVIEW: 1
    };

    Polymer({

      is: 'item-page-manager',

      currentState: pageState.OUTVIEW,

      behaviors: [Polymer.NeonAnimationRunnerBehavior],

      properties: {
        subRoute: {
          type: Object,
          observer: 'handleRoute'
        },

        animationConfig: {
            value: function() {
              return {
                'overlay-fade-in': {
                  name: 'fade-in-animation',
                  node: this.$.overlay
                },
                'overlay-fade-out': {
                  name: 'fade-out-animation',
                  node: this.$.overlay,
                  timing: {
                    delay: 250
                  }
                }
              }
          }
        },

        deleteAction: {
          type: Boolean,
          value: false
        },

        currentPage: {
          value: null
        },

        currentOverlay: {
          value: null
        },

        pageArray: {
          type: Array,
          value: []
        },
      },

      listeners: {
        'neon-animation-finish' : '_onNeonAnimationFinish'
      },

      ready: function() {
        window.addEventListener('close-page', function(p) {
          return function() {
            p.deletePage();
          }
        }(this));
      },

      initPage: function(item) {
        if (this.pageArray.length === 0) {
          this.fire('wheel-state', {active: false});
        }

        this.createPage(item);
        this.initOverlay();

        this.playAnimation('overlay-fade-in');
        this.pageEnterAnim(this.currentPage);
      },

      initOverlay: function() {
        this.currentState = pageState.INVIEW;
        this.$.overlay.style.zIndex = 3 + this.pageArray.length;
      },

      createPage: function(item) {
        var newPage = document.createElement('item-page');

        this.appendChild(newPage);

        newPage.setAttribute('id', item);
        newPage.setAttribute('item', item);
        newPage.style.display = 'none';
        newPage.style.zIndex = 4 + this.pageArray.length;

        this.pageArray.push(newPage);

        this.currentPage = newPage;
      },

      deletePage: function() {
        if (this.currentPage) {
          this.currentState = pageState.OUTVIEW;
          this.deleteAction = true;
          this.pageExitAnim(this.currentPage);
          this.playAnimation('overlay-fade-out');
        } else {
          return
        }
      },

      pageEnterAnim: function(element) {
        element.style.display = 'block';

        this.animationConfig['page-enter'] = {
          name: 'slide-from-right-animation',
          node: element,
          timing: {
            delay: 250
          }
        };

        this.playAnimation('page-enter');
      },

      pageExitAnim: function(element) {
        this.animationConfig['page-exit'] = {
          name: 'slide-right-animation',
          node: element
        };

        this.playAnimation('page-exit');
      },

      handleRoute: function() {
        if (this.subRouteData && this.subRouteData.item) {
          if (!this.currentPage || this.currentPage.getAttribute('item') != this.subRouteData.item) {
            this.style.display = 'block';
            this.initPage(this.subRouteData.item);
          }

          delete this.subRouteData.item;
        } else if (this.subRouteData && !this.subRouteData.item) {
          var currentLength = (this.pageArray.length - 1);

          for (i = 0; i < (currentLength); i++) {
            this.removeChild(this.pageArray[0]);
            this.pageArray.splice(0, 1);
          }

          this.deletePage();
        }
      },

      _onNeonAnimationFinish: function() {
        switch (this.currentState) {
          case pageState.OUTVIEW:
            if (this.deleteAction) {
              this.removeChild(this.currentPage);
              this.pageArray.splice(-1, 1);

              this.currentPage = this.pageArray[this.pageArray.length - 1];

              this.deleteAction = false;
            }

            if (this.pageArray.length > 0) {
              window.location = '#/Work/' + this.currentPage.getAttribute('item');

              this.$.overlay.style.zIndex = this.$.overlay.style.zIndex = 3 + this.pageArray.length;
            } else {
              window.location = '#/Work';

              this.$.overlay.style.opacity = 0;
              this.style.display = 'none';
              this.fire('wheel-state', {active: true});
            }
            break;
          case pageState.INVIEW:
            this.$.overlay.style.opacity = 1;
            break;
          default:
            console.log('wellshit');
        }
      }
    });
  </script>
</dom-module>
