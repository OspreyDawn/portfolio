<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">

<dom-module id="touch-test-area">
  <template>
    <style>
      .container {
        width: 100%;
        height: 100%;
        position: relative;
      }
    </style>

    <div class="container" id="container">
      <content></content>
    </div>

  </template>

  <script>
    Polymer({

      is: 'touch-test-area',

      behaviors: [Polymer.NeonAnimationRunnerBehavior],

      properties: {
        animationConfig: {
          value: function() {
            return [];
          }
        }
      },

      listeners: {
        'container.track' : 'handleTrack',
        'neon-animation-finish' : '_onNeonAnimationFinish'
      },

      viewWidth: 0,
      xPos: 0,
      xRelease: 0,
      xDeltaInit: 0,
      xDelta: 0,
      indexSelector: 0,
      indexLength: 0,

      handleTrack: function(e) {
        switch(e.detail.state) {
          case 'start' :
            this.xPos = e.detail.x;
            break;
          case 'track' :
            e.currentTarget.style.left = (e.detail.x - this.xPos) + 'px';
            break;
          case 'end' :
            this.xRelease = e.detail.x - this.xPos;
            this.snapElement(e.currentTarget);
            this.xPos = 0;
            break;
        }
      },

      keyGen: function(element, init, endPos) {
        this.animationConfig['translate'] = {
            name: 'transform-animation',
            node: element,
            transformFrom: 'translateX(' + init + 'px)',
            transformTo: 'translateX(' + endPos + 'px)',
            timing: {
              duration: 150,
              easing: 'ease-out'
            }
        }

        this.xEnd = endPos;
      },

      changePage: function(direction) {
        var indexInit = this.indexSelector;

        switch (direction) {
          case 'next':
            ++this.indexSelector;
            break;
          case 'prev':
            --this.indexSelector;
            break;
          default:
            console.log('borked');
        }

        currentPosition = this.viewWidth * indexInit;
        nextPosition = this.viewWidth * this.indexSelector;

        this.animationConfig['translate'] = {
          name: 'transform-animation',
          node: this.$.container,
          transformFrom: 'translateX(-' + currentPosition + 'px)',
          transformTo: 'translateX(-' + nextPosition + 'px)'
        }

        this.xEnd = 0 - nextPosition;

        this.playAnimation('translate');
        this.fire('item-page-changed', {vector: direction, indexSelector: this.indexSelector});
      },

      coordGen: function(element, direction) {
        var distance = this.viewWidth;

        this.xInit = this.xRelease - (distance * this.indexSelector);

        switch (direction) {
          case 'next':
            this.indexSelector++;
            break;
          case 'prev':
            this.indexSelector--;
            break;
          default:
            this.indexSelector;
          };

        this.xEnd = -1 * distance * this.indexSelector;

        this.keyGen(element, this.xInit, this.xEnd);
      },

      snapElement: function(element) {
        var direction = null;

        if (this.xRelease < -400 && this.indexSelector < (this.indexLength - 1)) {
          direction = 'next';
        } else if (this.xRelease > 400 && this.indexSelector > 0) {
          direction = 'prev';
        }

        element.style.left = 'auto';

        this.coordGen(element, direction);
        this.playAnimation('translate');

        this.fire('item-page-changed', {vector: direction, indexSelector: this.indexSelector});
      },

      _onNeonAnimationFinish: function () {
        this.$$('.container').style.transform = 'translateX(' + this.xEnd + 'px)';
      }
    });
  </script>
</dom-module>
