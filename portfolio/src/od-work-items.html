<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">

<link rel="import" href="od-page-nav.html">
<link rel="import" href="touch-test-area.html">

<dom-module id="od-work-items" attribute="query on-display">
  <template>

    <style>
      :host {
        display: block;
        @apply(--layout-vertical);
      }
      touch-test-area {
        height: calc(100vh - 13.5rem);
        background: salmon;
      }
      .container {
        @apply(--layout-vertical);
        @apply(--layout-wrap);
      }
      .container:hover > div > .pjtMeta {
        opacity: 0.28;
      }
      .container:hover > div:hover > .pjtMeta {
        opacity: 1;
      }
      .container:hover > div:hover > .pjtImg {
        box-shadow: 0 3px 14px rgba(0, 0, 0, 0.21);
      }
      .workItem {
        width: 20rem;
        height: 15rem;
        margin-right: 4rem;
        margin-bottom: 0.5rem;
        transition: opacity 0.3s;
        @apply(--layout-vertical);
      }
      .pjtMeta {
        transition: opacity 0.3s;
      }
      .pjtImg {
        height: 12.5rem;
        margin-bottom: 0.5rem;
        background-color: white;
        border: 1px solid lightgrey;
        transition: box-shadow 0.3s;
      }
      .pjtSubtitle {
        color: grey;
      }
      /* Mobile Screen Layout Styles */
      .container[mobile-layout] {
        height: calc(100vh - 10.5rem);
      }
      .container[mobile-layout] .workItem {
        width: 100%;
        height: inherit;
        margin-right: 1.5rem;
      }
      .container[mobile-layout] .pjtImg {
        @apply(--layout-flex);
      }
      #pageNav[mobile-layout] {

      }
    </style>

    <iron-media-query
      query="{{query}}"
      query-matches="{{smallScreen}}">
    </iron-media-query>

    <touch-test-area view-size="{{viewSize}}" page-length="{{totalPages}}">
      <div id="itemContainer" class="container" mobile-layout$="{{smallScreen}}">
        <template is="dom-repeat" items="{{testArray}}">
          <div class="workItem">
            <div class="pjtImg">{{item}}</div>
            <div class="pjtMeta">
              <div class="pjtTitle">Project Name</div>
              <div class="pjtSubtitle">Year | Type</div>
            </div>
          </div>
        </template>
      </div>
    </touch-test-area>

    <od-page-nav id="pageNav" on-prev-tap="_prevTap" on-next-tap="_nextTap" mobile-layout$="{{smallScreen}}"></od-page-nav>
  </template>

  <script>
    pressedStates = {
      PREVPRESS: 0,
      NEXTPRESS: 1
    };

    Polymer({

      is: 'od-work-items',

      currentState: pressedStates.PREVPRESS,

      behaviors: [Polymer.NeonAnimationRunnerBehavior],

      properties: {
        animationConfig: {
          value: function() {
            return [];
          }
        }
      },

      viewSize: 0,
      pageSelect: 0,
      totalPages: 0,
      prevPosition: 0,
      nextPosition: 0,

      listeners: {
        'neon-animation-finish' : '_onNeonAnimationFinish'
      },

      ready: function() {
        this.testArray = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18];

        window.addEventListener('resize', function(p) {
          return function() {
            p.calcGrid();
          }
        }(this));
        window.addEventListener('page-changed', function(p) {
          return function(e) {
            if (e.detail.targetIndex === 1) {
              p.calcGrid();
            }
          }
        }(this));
      },

      calcGrid: function() {
        var view, pages = null;
        var containerW = this.$.itemContainer.offsetWidth;
        var itemPad = this.smallScreen ? 24 : 64;
        var itemW = this.$$('.workItem').offsetWidth + itemPad;

        if (this.smallScreen) {
          view = containerW + itemPad;
          pages = this.testArray.length;
        } else if (1240 > window.innerWidth){
          view = itemW * 2;
          pages = Math.round(this.testArray.length / 6);
        } else {
          view = itemW * 3;
          pages = Math.round(this.testArray.length / 9);
        }

        this.viewSize = view;
        this.totalPages = pages;

        console.log(this.viewSize, this.totalPages);
      },

      animateTransition: function() {
        if ((this.pageSelect + 1) < (this.totalPages)) {
          ++this.pageSelect;

          nextPosition = this.pageSelect * this.viewSize;

          this.animationConfig['transition'] = {
              name: 'transform-animation',
              node: this.$.itemContainer,
              transformFrom: 'translateX(-' + (nextPosition - this.viewSize) + 'px)',
              transformTo: 'translateX(-' + nextPosition + 'px)'
          };
        } else if (0 < this.pageSelect) {
          --this.pageSelect;

          prevPosition = this.pageSelect * this.viewSize;

          this.animationConfig['transition'] = {
            name: 'transform-animation',
            node: this.$.itemContainer,
            transformFrom: 'translateX(-' + (prevPosition + this.viewSize) + 'px)',
            transformTo: 'translateX(-' + prevPosition + 'px)'
          };
        }

          this.playAnimation('transition');
      },

      _prevTap: function() {
        this.currentState = pressedStates.PREVPRESS;

        if (this.pageSelect > 0) {
          this.animateTransition();
        }

        if (this.pageSelect === 0) {
          this.$.pageNav.hidePrevButton();
        } else if (this.pageSelect === 1) {
          this.$.pageNav.showPrevButton();
        };
      },

      _nextTap: function() {
        this.currentState = pressedStates.NEXTPRESS;

        if (this.pageSelect < this.totalPages) {
          this.animateTransition();
        }

        if (this.pageSelect === this.totalPages) {
          this.$.pageNav.hideNextButton();
        } else if (this.pageSelect === (this.totalPages - 1)) {
          this.$.pageNav.showNextButton();
        };
      },

      _onNeonAnimationFinish: function() {
        switch (this.currentState) {
          case pressedStates.PREVPRESS:
            this.$.itemContainer.style.transform = 'translateX(-' + prevPosition + 'px)';
            break;
          case pressedStates.NEXTPRESS:
            this.$.itemContainer.style.transform = 'translateX(-' + nextPosition + 'px)';
            break;
          default:
            console.log('uwotm8');
        }
      }
    });
  </script>
</dom-module>
